(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{431:function(t,a,s){"use strict";s.r(a);var n=s(14),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("Shiro漏洞复盘系列--1.5.3版本以下的权限绕过复现分析。（CVE-2020-11989）")]),t._v(" "),s("h2",{attrs:{id:"简介"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[t._v("#")]),t._v(" 简介")]),t._v(" "),s("p",[t._v("漏洞影响范围：shiro < 1.5.3")]),t._v(" "),s("p",[t._v("利用条件：")]),t._v(" "),s("ul",[s("li",[s("em",[t._v("Spring")]),t._v(" 需要设置 "),s("em",[t._v("ContextPath")])])]),t._v(" "),s("ul",[s("li",[s("em",[t._v("alwaysUseFullPath")]),t._v(" 必须设置为 "),s("em",[t._v("false")])])]),t._v(" "),s("h2",{attrs:{id:"配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[t._v("#")]),t._v(" 配置")]),t._v(" "),s("p",[t._v("Spring的版本配置有坑点，主要与的"),s("code",[t._v("alwaysUseFullPath")]),t._v("值有关。")]),t._v(" "),s("div",{staticClass:"language-xml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[t._v("    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("parent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.springframework.boot"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("spring-boot-starter-parent"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!--        <version>2.4.3</version>--\x3e")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("2.2.6.RELEASE"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("relativePath")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- lookup parent from repository --\x3e")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("parent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- shiro dependence --\x3e")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.apache.shiro"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("shiro-web"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("1.5.3"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.apache.shiro"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("shiro-spring"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("1.5.2"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("h2",{attrs:{id:"分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#分析"}},[t._v("#")]),t._v(" 分析")]),t._v(" "),s("p",[t._v("设置 "),s("code",[t._v("context-path")]),t._v(" 为 "),s("code",[t._v("test")]),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210321230516.png",alt:"image-20210321230509651"}})]),t._v(" "),s("p",[t._v("访问"),s("code",[t._v("/test/admin")]),t._v("，被shiro拦截：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210321230614.png",alt:"image-20210321230614028"}})]),t._v(" "),s("p",[t._v("访问"),s("code",[t._v("/;/test/admin")]),t._v("，绕过shiro鉴权：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210321230654.png",alt:"image-20210321230654282"}})]),t._v(" "),s("h3",{attrs:{id:"shiro"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#shiro"}},[t._v("#")]),t._v(" shiro")]),t._v(" "),s("p",[t._v("依然是在"),s("code",[t._v("org.apache.shiro.web.filter.mgt.PathMatchingFilterChainResolver#getChain")]),t._v("这个方法打下断点，调试shiro来处理URL请求的过程，跟进"),s("code",[t._v("getPathWithinApplication")]),t._v("方法：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210321231919.png",alt:"image-20210321231919360"}})]),t._v(" "),s("p",[t._v("通过"),s("code",[t._v("gerRequestUri")]),t._v("方法获得的结果是"),s("code",[t._v("/")]),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210321233255.png",alt:"image-20210321233254981"}})]),t._v(" "),s("p",[t._v("所以跟进到该方法内部调试，在"),s("code",[t._v("1.5.2")]),t._v("的补丁版本中我们知道URL的获取规则变成了"),s("code",[t._v("ContextPath")]),t._v("、"),s("code",[t._v("ServletPath")]),t._v("、"),s("code",[t._v("PathInfo")]),t._v("三者拼接而成：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210321233426.png",alt:"image-20210321233426337"}})]),t._v(" "),s("p",[t._v("问题就处在"),s("code",[t._v("getContextPath")]),t._v("方法中，经过这个方法之后可以获得带"),s("code",[t._v(";")]),t._v("号的"),s("code",[t._v("ContextPath")]),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210321234141.png",alt:"image-20210321234141918"}})]),t._v(" "),s("p",[t._v("三者拼接之后URL为"),s("code",[t._v("/;/test//admin")]),t._v("，之后传入"),s("code",[t._v("decodeAndCleanUriString")]),t._v("方法中，仅仅保留了"),s("code",[t._v(";")]),t._v("号前面的部分：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210321234354.png",alt:"image-20210321234353933"}})]),t._v(" "),s("p",[t._v("那么由shiro处理完成之后的结果就是"),s("code",[t._v("/")]),t._v("，从而绕过了shiro鉴权：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210321234545.png",alt:"image-20210321234545785"}})]),t._v(" "),s("h3",{attrs:{id:"spring"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#spring"}},[t._v("#")]),t._v(" Spring")]),t._v(" "),s("p",[t._v("Spring 是否调用 "),s("code",[t._v("getPathWithinServletMapping")]),t._v(" 方法和 "),s("code",[t._v("alwaysUseFullPath")]),t._v(" 的值有关，Spring官方称该值默认为 false，但是我在使用最新版Spring的时候却是默认为 true ，导致漏洞无法复现（待解决），下面两张图是不同版本的Spring的差异。")]),t._v(" "),s("p",[t._v("5.2.5版本的Spring：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210322081855.png",alt:"image-20210322081854865"}})]),t._v(" "),s("p",[t._v("5.3.4版本的Spring：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210322171135.png",alt:"image-20210322171135294"}})]),t._v(" "),s("p",[t._v("只有当"),s("code",[t._v("alwaysUseFullPath")]),t._v("为"),s("code",[t._v("false")]),t._v("的情况下才会进入"),s("code",[t._v("getPathWithinServletMapping")]),t._v("中，经过"),s("code",[t._v("getPathWithinServletMapping")]),t._v("处理之后可以正确获取到路径：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210322082728.png",alt:"image-20210322082728818"}})]),t._v(" "),s("p",[s("code",[t._v("getPathWithinApplication")]),t._v("方法中的处理逻辑在上一篇中已经分析过，这里不再赘述，"),s("code",[t._v("getServletPath")]),t._v("方法获取到的其实是"),s("code",[t._v("Request")]),t._v("对象的某个属性值：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210322083656.png",alt:"image-20210322083656733"}})]),t._v(" "),s("p",[t._v("正确获取到路径之后，就可以匹配对应的"),s("code",[t._v("Controller")]),t._v("了。")]),t._v(" "),s("h2",{attrs:{id:"修复"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#修复"}},[t._v("#")]),t._v(" 修复")]),t._v(" "),s("p",[t._v("漏洞的成因在于shiro和Spring对于"),s("code",[t._v(";")]),t._v("的处理逻辑不一样：")]),t._v(" "),s("ul",[s("li",[t._v("shiro会直接截断"),s("code",[t._v(";")]),t._v("号后面的部分")]),t._v(" "),s("li",[t._v("Spring会截断"),s("code",[t._v(";")]),t._v("号和其后第一个"),s("code",[t._v("/")]),t._v("的部分，然后剩余部分作拼接处理")])]),t._v(" "),s("p",[t._v("1.5.3版本的shiro修复如下：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210322142711.png",alt:"image-20210322142710956"}})]),t._v(" "),s("p",[t._v("shiro使用了标准的"),s("code",[t._v("getServletPath(request) + getPathInfo(request)")]),t._v("来进行URL的处理，同时不再获取"),s("code",[t._v("ContextPath")]),t._v("，之后会进行格式化处理，就无法利用"),s("code",[t._v(";")]),t._v("进行绕过。")])])}),[],!1,null,null,null);a.default=e.exports}}]);