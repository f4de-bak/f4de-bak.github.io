(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{430:function(t,a,s){"use strict";s.r(a);var n=s(14),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("Shiro漏洞复盘系列--1.5.2版本以下的权限绕过复现分析。（CVE-2020-1957）")]),t._v(" "),s("h2",{attrs:{id:"简介"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[t._v("#")]),t._v(" 简介")]),t._v(" "),s("p",[t._v("漏洞影响范围：shiro < 1.5.2")]),t._v(" "),s("h2",{attrs:{id:"配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[t._v("#")]),t._v(" 配置")]),t._v(" "),s("div",{staticClass:"language-xml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[t._v("        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- shiro dependence --\x3e")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.apache.shiro"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("shiro-web"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("1.5.1"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.apache.shiro"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("shiro-spring"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("1.4.2"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[t._v("shiro config同上一篇文章。")]),t._v(" "),s("h2",{attrs:{id:"分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#分析"}},[t._v("#")]),t._v(" 分析")]),t._v(" "),s("p",[t._v("访问"),s("code",[t._v("/admin/")]),t._v("，已经无法绕过shiro过滤器的拦截：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210318204849.png",alt:"image-20210318204406613"}})]),t._v(" "),s("p",[t._v("访问"),s("code",[t._v("/;/admin")]),t._v("，成功绕过shiro拦截：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210318204845.png",alt:"image-20210318204649795"}})]),t._v(" "),s("h3",{attrs:{id:"shiro"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#shiro"}},[t._v("#")]),t._v(" shiro")]),t._v(" "),s("p",[t._v("还是在"),s("code",[t._v("org.apache.shiro.web.filter.mgt.PathMatchingFilterChainResolver#getChain")]),t._v("，打下断点，发送请求：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210318205038.png",alt:"image-20210318205038597"}})]),t._v(" "),s("p",[t._v("主要在"),s("code",[t._v("getPathWithApplication")]),t._v("方法里：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210318205119.png",alt:"image-20210318205119386"}})]),t._v(" "),s("p",[t._v("这里会获取到请求的"),s("code",[t._v("contextPath")]),t._v("和"),s("code",[t._v("requestUri")]),t._v("，获取到"),s("code",[t._v("uri")]),t._v("为"),s("code",[t._v("/;/admin")]),t._v("之后进入"),s("code",[t._v("decodeAndCleanUriString")]),t._v("方法中：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210318205306.png",alt:"image-20210318205306717"}})]),t._v(" "),s("p",[s("code",[t._v("decodeAndCleanUriString")]),t._v("方法中把请求的"),s("code",[t._v("uri")]),t._v("按分号进行截断：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210318205340.png",alt:"image-20210318205340398"}})]),t._v(" "),s("p",[s("code",[t._v("/;/admin")]),t._v("经过shiro的处理之后，我们请求的路由就变成了"),s("code",[t._v("/")]),t._v("，由于"),s("code",[t._v("/")]),t._v("路由下没有设置过滤器，所以就shiro的过滤器无法匹配，绕过了shiro的权限认证。")]),t._v(" "),s("h3",{attrs:{id:"spring"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#spring"}},[t._v("#")]),t._v(" Spring")]),t._v(" "),s("p",[t._v("依然在"),s("code",[t._v("org.springframework.web.util.UrlPathHelper#getLookupPathForRequest")]),t._v("方法中打下断点，发送请求开始调试：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210319003838.png",alt:"image-20210319003838013"}})]),t._v(" "),s("p",[t._v("这次主要跟入"),s("code",[t._v("getPathWithinApplication")]),t._v("方法：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210319003935.png",alt:"image-20210319003935113"}})]),t._v(" "),s("p",[t._v("再跟入"),s("code",[t._v("getRequestUri")]),t._v("方法：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210319004024.png",alt:"image-20210319004024544"}})]),t._v(" "),s("p",[t._v("主要看"),s("code",[t._v("decodeAndCleanUriString")]),t._v("方法，这个方法中对请求的路由做了一些处理：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210319004119.png",alt:"image-20210319004119307"}})]),t._v(" "),s("p",[t._v("跟入第一个方法"),s("code",[t._v("removeSemicolonContent")]),t._v("，经过这部分代码处理之后"),s("code",[t._v("/;/admin")]),t._v("变成了"),s("code",[t._v("//admin")]),t._v("，在这个方法中，会把"),s("code",[t._v(";")]),t._v("到后面第一个"),s("code",[t._v("/")]),t._v("之间的字符串全部去掉（包括"),s("code",[t._v(";")]),t._v("），比如"),s("code",[t._v("/;xxx/")]),t._v("经过处理之后就变成了"),s("code",[t._v("//")]),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210319004437.png",alt:"image-20210319004437224"}})]),t._v(" "),s("p",[t._v("再跟入第三个方法"),s("code",[t._v("getSanitizedPath")]),t._v("，在获取到"),s("code",[t._v("//")]),t._v("的索引值之后，直接删除该索引上对应的字符，"),s("code",[t._v("//admin")]),t._v("也就变了"),s("code",[t._v("/admin")]),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210319004636.png",alt:"image-20210319004636257"}})]),t._v(" "),s("p",[t._v("最后也就返回了"),s("code",[t._v("/admin")]),t._v("的路由，之后就是正常匹配 "),s("em",[t._v("hanlderMethod")]),t._v(" 的过程了，不再赘述：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210319004921.png",alt:"image-20210319004921899"}})]),t._v(" "),s("h2",{attrs:{id:"修复"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#修复"}},[t._v("#")]),t._v(" 修复")]),t._v(" "),s("p",[t._v("1.5.2版本的"),s("code",[t._v("org.aoache.shiro.web.util.WebUtils#getRequestUri")]),t._v("方法如下：")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getRequestUri")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HttpServletRequest")]),t._v(" request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" uri "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getAttribute")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"javax.servlet.include.request_uri"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("uri "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            uri "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("valueOrEmpty")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getContextPath")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("valueOrEmpty")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getServletPath")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("valueOrEmpty")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getPathInfo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("normalize")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("decodeAndCleanUriString")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" uri"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("uri获取的规则变成了"),s("code",[t._v("ContextPath")]),t._v(" 、"),s("code",[t._v("ServletPath")]),t._v("、"),s("code",[t._v("PathInfo")]),t._v("三者拼接而成：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image-1302577725.cos.ap-beijing.myqcloud.com/img/20210319092755.png",alt:"image-20210319092755726"}})]),t._v(" "),s("p",[s("code",[t._v("getServletPath")]),t._v("方法可以正确处理分号，再经过后续方法处理，"),s("code",[t._v("/;/admin")]),t._v("就被正常处理为了"),s("code",[t._v("/admin")]),t._v("，之后就会被shiro的过滤器正常拦截。")])])}),[],!1,null,null,null);a.default=e.exports}}]);